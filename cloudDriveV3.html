<!DOCTYPE html>
<html lang="cn">

<head>
    <!-- Basic -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCS - 文件中转</title>
    <!-- Custom CSS -->

    <!-- Third-Party CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <!-- Favicon -->
    <link rel="shortcut icon" href="./images/favicon.png" type="image/x-icon">
</head>

<body style="background-color: #F5F3EB !important;">

    <div class="container my-5">

        <div class="p-5 text-center bg-body-tertiary rounded-3 text-warning-emphasis bg-warning-subtle border border-warning-subtle">

            <!-- <h1 class="mt-3 text-body-emphasis">2025 新年快乐</h1> -->
            <!-- <p class="col-lg-8 mx-auto fs-5 text-muted">
                当前提供TeamSpeak语音服务器, Minecraft游戏服务器，以及KOOK语音频道。
            </p> -->
            <!-- <div class="d-inline-flex gap-2 mb-3">
                <a class="d-inline-flex align-items-center btn btn-danger" href="./mc.html" role="button"> 加入 Minecraft </a>
            </div> -->






        </div>

        <div class="b-example-divider mt-2 mb-2"></div>

        <div class="p-5 text-center bg-body-tertiary rounded-3 text-success-emphasis bg-success-subtle border border-success-subtle">

            <!-- <a class="d-inline-flex align-items-center btn btn-primary " href="https://github.com/AlcaProphet/kylecloudservices" role="button"> Opensource Repository </a> -->

        </div>
    </div>

</body>

<body>
    <div class="container my-5">
        <h1 class="text-center">File Manager</h1>
        <div id="result" class="alert alert-secondary" role="alert" style="display: none;"></div>
        <table class="table table-striped mt-4">
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="fileList">
                <!-- File list will be dynamically generated here -->
            </tbody>
        </table>
    </div>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script>

                // URLs for the Worker
        // const LIST_URL = 'https://drivequerylist.kylecloudservices.com'; // Replace with the Worker URL for listing files
        const getListURL = 'https://drivequerylist.kylecloudservices.com'; // Replace with the Worker URL for listing files
        // const DELETE_URL = 'https://driveworker.kylecloudservices.com'; // Replace with the Worker URL for deleting files
        const workerURL = 'https://driveworker.kylecloudservices.com'; // Replace with the Worker URL for deleting files
        // const AUTH_SECRET_KEY = ''; // Replace with your secret key
        const fileListElement = document.getElementById('fileList');
        const resultDiv = document.getElementById('result');

        function showMessage(message, type = 'success') {
            resultDiv.style.display = 'block';
            resultDiv.className = `alert alert-${type}`;
            resultDiv.textContent = message;
        }

        function showNotification(message, alertType) {
            resultDiv.style.display = 'block';
            resultDiv.className = `alert alert-${alertType}`;
            resultDiv.textContent = message;
        }

        async function fetchFileList() {
            try {
                const response = await fetch(getListURL, {
                    method: 'GET',
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const files = await response.json();
                
                displayFiles(files);
            } catch (error) {
                showMessage(`获取文件列表失败（不是你的问题）: ${error.message}`, 'danger');
            }
        }

        // function displayFileList(files) {
        //     fileListElement.innerHTML = ''; // Clear the table
        //     files.forEach(file => {
        //         const row = document.createElement('tr');
        //         row.innerHTML = `
        //             <td>${file.key}</td>
        //             <td>
        //                 <button class="btn btn-danger btn-sm" onclick="deleteFile('${file.key}')">Delete</button>
        //             </td>
        //         `;
        //         fileListElement.appendChild(row);
        //     });
        // }


        function displayFiles(files) {
            const tableBody = document.getElementById('fileList');
            tableBody.innerHTML = ''; // Clear any existing rows

            files.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${file.key}</td>
                    <td>${file.size}</td>
                    <td>${new Date(file.lastModified).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="downloadFile('${file.key}')">下载</button>
                        <button class="btn btn-danger" onclick="deleteFile('${file.key}')">删除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }



        async function deleteFile(fileName) {
            const confirmation = confirm(`确定要删除 ${fileName} 吗?`);
            if (!confirmation) return;

            try {
                const response = await fetch(`${workerURL}/${encodeURIComponent(fileName)}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                showMessage(`"${fileName}" 删除成功！`);
                fetchFileList(); // Refresh the file list  
            } catch (error) {
                showMessage(`删除失败 (不是你的问题) ${error.message} `, 'danger');
            }

            // try {
            //     const response = await fetch(`${DELETE_URL}/${encodeURIComponent(fileName)}`, {
            //         method: 'DELETE',
            //     });

            //     if (!response.ok) {
            //         throw new Error(await response.text());
            //     }

            //     showMessage(`文件 "${fileName}" deleted successfully.`);
            //     fetchFileList(); // Refresh the file list
            // } catch (error) {
            //     showMessage(`Error deleting file: ${error.message}`, 'danger');
            // }
        }

        // Fetch the file list on page load
        fetchFileList();
    </script>
</body>

</html>