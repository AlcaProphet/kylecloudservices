<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R2 File Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">R2 File Manager</h1>
    <table class="table table-bordered table-striped mt-4">
      <thead>
        <tr>
          <th>File Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="fileTable">
        <!-- Rows will be dynamically added here -->
      </tbody>
    </table>
  </div>

  <script>
    async function fetchFiles() {
      try {
        // Fetch the JSON data from the Worker
        const response = await axios.get('https://drivequerylist.kylecloudservices.com/'); // Replace with your Worker URL
        const files = response.data;

        const fileTable = document.getElementById('fileTable');
        fileTable.innerHTML = ''; // Clear existing rows

        files.forEach(file => {
          const row = document.createElement('tr');

          // File Name Column
          const nameCell = document.createElement('td');
          nameCell.textContent = file.key;
          row.appendChild(nameCell);

          // Actions Column
          const actionCell = document.createElement('td');

          // Download Button
          const downloadButton = document.createElement('button');
          downloadButton.className = 'btn btn-primary btn-sm me-2';
          downloadButton.textContent = 'Download';
          downloadButton.onclick = () => downloadFile(file.key);
          actionCell.appendChild(downloadButton);

          // Delete Button
          const deleteButton = document.createElement('button');
          deleteButton.className = 'btn btn-danger btn-sm';
          deleteButton.textContent = 'Delete';
          deleteButton.onclick = () => deleteFile(file.key);
          actionCell.appendChild(deleteButton);

          row.appendChild(actionCell);
          fileTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error fetching files:', error);
        alert('Failed to load files. Please check the console for details.');
      }
    }

    async function downloadFile(fileName) {
      try {
        const response = await axios.get(`https://driveworker.kylecloudservices.com/${fileName}`, {
          responseType: 'blob', // Ensure the response is treated as a file
        });

        // Create a download link and trigger it
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', fileName);
        document.body.appendChild(link);
        link.click();
        link.remove();

      } catch (error) {
        console.error('Error downloading file:', error);
        alert('Failed to download the file. Please check the console for details.');
      }
    }

    async function deleteFile(fileName) {
      try {
        const confirmDelete = confirm(`Are you sure you want to delete ${fileName}?`);
        if (!confirmDelete) return;

        await axios.delete(`https://driveworker.kylecloudservices.com/${fileName}`); // Replace with DELETE endpoint URL
        alert(`${fileName} has been deleted.`);

        // Refresh the file list
        fetchFiles();
      } catch (error) {
        console.error('Error deleting file:', error);
        alert('Failed to delete the file. Please check the console for details.');
      }
    }

    // Fetch and display files on page load
    fetchFiles();
  </script>
</body>
</html>
